#!/bin/bash
set -e

LOG_DIR="/tmp/logs"
#mkdir -p "$LOG_DIR"
MAIN_LOG="$LOG_DIR/post_appuser.log"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$1] $2" | tee -a "$MAIN_LOG"
}

#log "INFO" "开始查找图标文件..."
#find /tmp/navpage/icons -type f > /tmp/navpage/icons.txt
#log "INFO" "图标文件列表已保存到 /tmp/navpage/icons.txt"

#log "INFO" "更新 hosts 脚本已准备，暂未启用"
#cat /tmp/update_hosts.sh.txt | tee /tmp/update_hosts.sh > /dev/null

log "INFO" "开始生成 RSS 新闻..."
python3 /tmp/navpage/private_html/rss_news.py >> "$MAIN_LOG" 2>&1 && \
log "INFO" "RSS 新闻生成完成"

log "INFO" "生成导航页..."
python3 /tmp/navpage/private_html/generate_nav.py >> "$MAIN_LOG" 2>&1 && \
log "INFO" "导航页生成完成"

#curl -s "https://raw.githubusercontent.com/rakersfu/gist/main/index.html" -o /tmp/navpage/index.html
curl -s "https://raw.githubusercontent.com/rakersfu/gist/main/txt_to_html.sh" -o /tmp/txt_to_html.sh
#su - appuser -c "bash /tmp/txt_to_html.sh"

log "INFO" "开始生成 私有资源 首页..."
python3 /tmp/navpage/private_html/generate_portal_config_pinyin_mulu.py >> "$MAIN_LOG" 2>&1 && \
log "INFO" "私有资源 首页生成完成"

GIST_cron_status="https://raw.githubusercontent.com/rakersfu/gist/main/generate_cron_status_html.py"
log "INFO" "正在生成 cron_status_html 页面..."
if curl -s "$GIST_cron_status" | python3 > /dev/null; then
  log "INFO" "cron_status_html 页面已生成"
else
  log "ERROR" "cron_status_html 页面生成失败"
fi

GIST_index_html="https://raw.githubusercontent.com/rakersfu/gist/main/index.html"
log "INFO" "正在下载 index.html 页面..."
if curl -s "$GIST_index_html" | tee /tmp/navpage/index.html > /dev/null; then
  log "INFO" "index.html 页面已保存到 /tmp/navpage/index.html"
else
  log "ERROR" "index.html 页面下载失败"
fi
